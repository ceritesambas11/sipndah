<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aplikasi Sistem Informasi Pendonor Darah</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jsPDF & autotable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-5xl mx-auto bg-white rounded-xl shadow-lg p-6">
    <h1 class="text-2xl font-bold text-center mb-6">üìå SIP NDAH UPD RSUD PEMANGKAT </h1>

    <!-- Form Input Data Pasien -->
    <div class="mb-6">
      <h2 class="text-lg font-semibold mb-2">Tambah Data Pasien</h2>
      <form id="donorForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <input type="text" id="nama" placeholder="Nama" required class="border rounded p-2">
        <input type="number" id="umur" placeholder="Umur" required class="border rounded p-2">
        <select id="golongan" required class="border rounded p-2">
          <option value="">Golongan Darah</option>
          <option>A+</option><option>A-</option>
          <option>B+</option><option>B-</option>
          <option>O+</option><option>O-</option>
          <option>AB+</option><option>AB-</option>
        </select>
        <input type="date" id="tanggal" required class="border rounded p-2">
        <button type="submit" class="col-span-1 md:col-span-4 bg-red-500 text-white rounded p-2 hover:bg-red-600">Simpan</button>
      </form>
    </div>

    <!-- Filter Nama & Golongan -->
    <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-4">
      <input type="text" id="searchInput" placeholder="üîç Cari berdasarkan nama..." class="border rounded p-2">
      <select id="filterGolongan" class="border rounded p-2">
        <option value="">üîç Semua Golongan</option>
        <option>A+</option><option>A-</option>
        <option>B+</option><option>B-</option>
        <option>O+</option><option>O-</option>
        <option>AB+</option><option>AB-</option>
      </select>
    </div>

    <!-- Tombol Export -->
    <div class="mb-4 flex gap-3">
      <button id="exportPDF" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Export PDF</button>
      <button id="exportExcel" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Export Excel</button>
    </div>

    <!-- Tabel Data Pasien -->
    <div>
      <h2 class="text-lg font-semibold mb-2">Riwayat Donor</h2>
      <div class="overflow-x-auto">
        <table id="dataTableWrapper" class="w-full border border-gray-300 text-sm">
          <thead class="bg-gray-200">
            <tr>
              <th class="border px-2 py-1">Nama</th>
              <th class="border px-2 py-1">Umur</th>
              <th class="border px-2 py-1">Gol. Darah</th>
              <th class="border px-2 py-1">Jumlah Donor</th>
              <th class="border px-2 py-1">Riwayat</th>
            </tr>
          </thead>
          <tbody id="dataTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const donorForm = document.getElementById("donorForm");
    const dataTable = document.getElementById("dataTable");
    const searchInput = document.getElementById("searchInput");
    const filterGolongan = document.getElementById("filterGolongan");

    const exportPDFBtn = document.getElementById("exportPDF");
    const exportExcelBtn = document.getElementById("exportExcel");

    let pasienList = JSON.parse(localStorage.getItem("pasienList")) || [];

    // Render data ke tabel dengan filter
    function renderTable(filterNama = "", filterGol = "") {
      dataTable.innerHTML = "";
      pasienList
        .filter(p =>
          p.nama.toLowerCase().includes(filterNama.toLowerCase()) &&
          (filterGol === "" || p.golongan === filterGol)
        )
        .forEach((p) => {
          let row = `<tr>
            <td class='border px-2 py-1'>${p.nama}</td>
            <td class='border px-2 py-1 text-center'>${p.umur}</td>
            <td class='border px-2 py-1 text-center'>${p.golongan}</td>
            <td class='border px-2 py-1 text-center'>${p.riwayat.length}</td>
            <td class='border px-2 py-1'>${p.riwayat.join(", ")}</td>
          </tr>`;
          dataTable.innerHTML += row;
        });
    }

    // Simpan data
    donorForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const nama = document.getElementById("nama").value.trim();
      const umur = document.getElementById("umur").value;
      const golongan = document.getElementById("golongan").value;
      const tanggal = document.getElementById("tanggal").value;

      let pasien = pasienList.find(p => p.nama.toLowerCase() === nama.toLowerCase() && p.umur == umur && p.golongan === golongan);
      if (pasien) {
        pasien.riwayat.push(tanggal);
      } else {
        pasienList.push({ nama, umur, golongan, riwayat: [tanggal] });
      }

      localStorage.setItem("pasienList", JSON.stringify(pasienList));
      donorForm.reset();
      renderTable(searchInput.value, filterGolongan.value);
    });

    // Filter saat mengetik nama atau pilih golongan
    searchInput.addEventListener("input", () => {
      renderTable(searchInput.value, filterGolongan.value);
    });

    filterGolongan.addEventListener("change", () => {
      renderTable(searchInput.value, filterGolongan.value);
    });

    // Export ke PDF
    exportPDFBtn.addEventListener("click", () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Laporan Riwayat Donor Darah", 14, 15);
      doc.autoTable({
        html: "#dataTableWrapper",
        startY: 20,
        styles: { fontSize: 8 }
      });
      doc.save("riwayat_donor.pdf");
    });

    // Export ke Excel
    exportExcelBtn.addEventListener("click", () => {
      const wb = XLSX.utils.book_new();
      const ws_data = [
        ["Nama", "Umur", "Golongan Darah", "Jumlah Donor", "Riwayat"]
      ];
      pasienList.forEach(p => {
        ws_data.push([p.nama, p.umur, p.golongan, p.riwayat.length, p.riwayat.join(", ")]);
      });
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.book_append_sheet(wb, ws, "Riwayat Donor");
      XLSX.writeFile(wb, "riwayat_donor.xlsx");
    });

    renderTable();
  </script>
</body>
</html>
